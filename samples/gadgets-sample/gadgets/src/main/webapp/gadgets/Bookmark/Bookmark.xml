<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="Bookmarks" description="Bookmarks list.">
    <Locale messages="locale/default.xml" />
    <Locale lang="fr" messages="locale/fr.xml" />
    <Locale lang="it" messages="locale/it.xml" />
    <Require feature="dynamic-height"/>
  </ModulePrefs>
  
  <Content type="html">
  <![CDATA[     
    
  <head>
    <link type="text/css" rel="stylesheet" href="/exo-gadget-resources/skin/exo-gadget/gadget-common.css" />
    <link type="text/css" rel="stylesheet" href="/intranet-gadgets/skin/css/Bookmark.css" />
  <link rel="stylesheet" type="text/css" href="/eXoResources/skin/css/Core.css" />
    <link rel="stylesheet" type="text/css" href="/eXoResources/skin/bootstrap/css/bootstrap.css" />
  
    <script language="javascript" type="text/javascript" src="/exo-gadget-resources/script/jquery/1.6.2/jquery.min.js"></script>
      
    <script type="text/javascript">
    $(function() {

    	function addBookmark(id, name, link) {
    		var element = '<li class="ListItem"> \
                      <div class="editHoverZone pull-right" style="display:none;">  \
                      <a href="#" class="pull-right"><i class="uiIconDelete uiIconLightGray"></i></a> \
                      <a href="#" class="pull-right"><i class="uiIconEdit uiIconLightGray"></i></a>  \
                      </div> \
                      <a id="bookmark'
    				+ id
    				+ '" class="bookmark" href="'
    				+ link
    				+ '" target="_parent">'
    				+ name
    				+ '</a> \
                      <div class="editZone" style="display:none;">  \
                        <div class="uiGrayLightBox pull-left" >     \
                               <input type="text" class ="editName" value="'
    				+ name
    				+ '"/>    \
                               <input type="text" class ="editLink" value="'
    				+ link
    				+ '"/> \
                          </div> \
                       <button type="button" class="btn btn-primary pull-left save">Save</button> \
                       <button type="button" class="btn pull-left cancel">Cancel</button> \
                       </div> \
                       </li> ';
    		$("#BookmarkList").append(element);
    	}

    	$.getJSON("/rest/bookmarks/get", function(bookmarks) {
    		$.each(bookmarks, function(i, bookmark) {
    			var link2 = bookmark.link.replace(/__SLASH__/g, "/").replace(
    					"/$PORTAL", parent.parent.eXo.env.portal.context).replace(
    					"$SITENAME", parent.parent.eXo.env.portal.portalName);
    			addBookmark(i, bookmark.name.replace(/__SLASH__/g, "/"), link2);
    		});
    		if (bookmarks.length == 0) {
    			$("#message").show();
    		}
    		gadgets.window.adjustHeight($("#content").get(0).offsetHeight);
    	});
    	changeToViewMode();
    	var preventDefault = function(e) {
    		e.preventDefault()
    	};

    	$("#BookmarkList").delegate(
    			".save",
    			"click",
    			function() {
    				var newName = $(this).closest(".ListItem").find(
    						"input:text[class=editName]").val();
    				var newLink = $(this).closest(".ListItem").find(
    						"input:text[class=editLink]").val();
    				if (newName.length == 0 || newLink.length == 0)
    					return false;
    				var $thisBookmark = $(this).closest(".ListItem").find(
    						"a[id^=bookmark]");
    				$thisBookmark.text(newName);
    				$thisBookmark.attr("href", newLink);
    				$.getJSON("/rest/bookmarks/set/"
    						+ toJson().replace(/\//g, "__SLASH__"), null);
    				$(this).closest(".ListItem").find("div.editZone").hide();
    				changeToViewMode();
    			});

    	$("#BookmarkList").delegate(".cancel", "click", function() {
    		$(this).closest(".ListItem").find("div.editZone").hide();
    		changeToViewMode();
    	});

    	// click on edit, go to the edit mode;
    	$("#BookmarkList").delegate(".uiIconEdit", "click", function() {
    		//hide the icon modify and delete
    		$(this).closest(".ListItem").find("div.editZone").show();
    		// gadgets.window.adjustHeight($("#content").get(0).offsetHeight);
    		changeToEditMode();
    	});

    	$("#BookmarkList").delegate(
    			".uiIconDelete",
    			"click",
    			function() {
    				$(this).closest('.ListItem').remove();
    				$.getJSON("/rest/bookmarks/set/"
    						+ toJson().replace(/\//g, "__SLASH__"), null);
    				if ($("#BookmarkList").find(".ListItem").length == 0) {
    					$("#message").show();
    				}
    				gadgets.window.adjustHeight($("#content").get(0).offsetHeight);

    			});

    	function changeToViewMode() {
    		$("#BookmarkList").delegate(".ListItem", "mouseover mouseout",
    				function(e) {
    					if (e.type == "mouseover") {
    						$(this).find("div.editHoverZone").show();
    						$(this).addClass("active");
    					} else {
    						$(this).find("div.editHoverZone").hide();
    				     	$(this).removeClass("active");
    					}
    				});
    		$("#BookmarkList").find("div.editZone").each(function() {
    			$(this).hide();
    		});
    		$("#customize").bind("click", function() {
    			addNewBookMark();
    			$("#message").hide();
    		});
    		gadgets.window.adjustHeight($("#content").get(0).offsetHeight);
    	}

    	function changeToEditMode() {
    		$("#BookmarkList").undelegate(".ListItem", "mouseover mouseout");
    		$("#BookmarkList").find(".editHoverZone").each(function() {
    			$(this).hide();
    		});
    		$("a[id^=bookmark]").bind("click", preventDefault);
    		$("#customize").unbind();
    		gadgets.window.adjustHeight($("#content").get(0).offsetHeight);
    	}

    	function toJson() {
    		var bookmarks = [];
    		$("#BookmarkList .ListItem").each(function(index) {
    			$bookmark = $(this).find("a[id^=bookmark]");
    			var bookmark = "{";
    			bookmark += '"name":"' + $bookmark.text() + '",';
    			bookmark += '"link":"' + $bookmark.attr("href") + '"}';
    			bookmarks.push(bookmark);
    		});
    		return "[" + bookmarks.join(",") + "]";
    	}

    	function addNewBookMark() {
    		var element = '<li class="ListItem"> \
                    <div class="editHoverZone pull-right" style="display:none;">  \
                    <a href="#" class="pull-right"><i class="uiIconDelete uiIconLightGray"></i></a> \
                    <a href="#" class="pull-right"><i class="uiIconEdit uiIconLightGray"></i></a>  \
                    </div> \
                    <a id="bookmarkXXXX" class="bookmark" href="#" target="_parent"></a> \
                    <div class="editZone">  \
                      <div class="uiGrayLightBox pull-left" >     \
                             <input type="text" class ="editName" value=""/>    \
                             <input type="text" class ="editLink" value=""/> \
                        </div> \
                     <button type="button" class="btn btn-primary pull-left save">Save</button> \
                     <button type="button" class="btn pull-left cancel">Cancel</button> \
                     </div> \
                     </li> ';
    		$("#BookmarkList").append(element);
    		changeToEditMode();
    		gadgets.window.adjustHeight($("#content").get(0).offsetHeight + 100);
    	}

    	function checkIfZeroBookMark() {
    		$.getJSON("/rest/bookmarks/get", function(bookmarks) {
    			if (bookmarks.length == 0) {
    				$("#message").show();
    			}
    		});
    	}

    });

    </script>
  </head>
 
    <div id="content" class="UIGadgetThemes">
       <div class="TitGad ClearFix">
          <div style="float:right; margin-top:2px; margin-right:10px;">
          <h6 class="title center clearfix">
 						<a id="customize" href="#" class="actionIcon pull-right">
   								<i class="uiIconPlus uiIconLightGrey"></i>
 						</a>
   					Bookmark
		  </h6>
          </div>
          <div class="ContTit">__MSG_title__</div>
       </div>
    
      <div class="ContBookmark GadCont">
      <div id="message" style="display:none;">
      		You don't have any BookMark : add them by click on
 						<a id="#" href="#" class="actionIcon">
   								<i class="uiIconPlus uiIconLightGrey"></i>
 						</a>
      button
      </div>
        <div id="BookmarkList" class="BookMarks"></div>
        </div>
      </div>
      
     </div>
  ]]>
</Content>
</Module>